@startuml Password Update Sequence Diagram - CozyShelf

!theme plain
skinparam backgroundColor white
skinparam sequenceArrowThickness 2
skinparam roundcorner 20
skinparam maxMessageSize 60
skinparam sequenceParticipant underline
skinparam dpi 300

actor Client as "Cliente"
participant Router as "Express Router"
participant Controller as "ClientController"
participant PasswordService as "PasswordService"
participant ClientDAO as "ClientDAO"
participant PasswordDAO as "PasswordDAO"
participant PasswordDomain as "Password (Domain)"
participant Database as "PostgreSQL"

== Atualização de Senha ==

Client -> Router: PUT /clients/:id/password
note right: Body: {\n  currentPassword,\n  newPassword,\n  newPasswordConfirmation\n}
activate Router

Router -> Controller: updatePassword(req, res)
activate Controller

Controller -> Controller: Extract id from req.params
Controller -> Controller: Extract IUpdatePasswordData from req.body

Controller -> PasswordService: updatePasswordByClientId(clientId, updatedPasswordData)
activate PasswordService

' Verificar se cliente existe
PasswordService -> ClientDAO: findById(clientId)
activate ClientDAO
ClientDAO -> Database: SELECT * FROM clients WHERE id = ?
activate Database
Database --> ClientDAO: ClientModel | null
deactivate Database
ClientDAO --> PasswordService: ClientModel | null
deactivate ClientDAO

alt Cliente não encontrado
    PasswordService -> Controller: throw NoClientsFound(clientId)
    Controller -> Router: res.status(404).json(error)
    Router -> Client: 404 - Cliente não encontrado
else Cliente encontrado
    PasswordService -> PasswordService: Get currentPasswordModel from existingClient
    PasswordService -> PasswordService: passwordEntity = currentPasswordModel.toEntity()

    ' Validação e atualização da senha
    PasswordService -> PasswordDomain: updateData(updatedPasswordData)
    activate PasswordDomain

    ' Validação da nova senha
    PasswordDomain -> PasswordDomain: validatePassword(newPassword)
    note right: Regex: ^(?=.*[a-z])(?=.*[A-Z])(?=.*\\W).{8,20}$

    alt Senha não atende critérios
        PasswordDomain -> PasswordService: throw InvalidPasswordStrength()
        PasswordService -> Controller: InvalidPasswordStrength Exception
        Controller -> Router: res.status(422).json(error)
        Router -> Client: 422 - Senha não atende aos critérios
    else Senha válida
        ' Validação de confirmação
        PasswordDomain -> PasswordDomain: validatePasswordConfirmation(newPassword, confirmation)

        alt Confirmação não confere
            PasswordDomain -> PasswordService: throw InvalidPasswordConfirmation()
            PasswordService -> Controller: InvalidPasswordConfirmation Exception
            Controller -> Router: res.status(422).json(error)
            Router -> Client: 422 - Confirmação de senha não confere
        else Confirmação válida
            ' Validação da senha atual
            PasswordDomain -> PasswordDomain: comparePasswords(currentPassword)
            note right: bcrypt.compareSync(plainText, hashedPassword)

            alt Senha atual incorreta
                PasswordDomain -> PasswordService: throw PasswordsNotMatch()
                PasswordService -> Controller: PasswordsNotMatch Exception
                Controller -> Router: res.status(422).json(error)
                Router -> Client: 422 - Senha atual incorreta
            else Senha atual correta
                ' Criptografar nova senha
                PasswordDomain -> PasswordDomain: encrytPassword(newPassword)
                note right: bcrypt.hashSync(newPassword, salt)
                PasswordDomain -> PasswordDomain: this.value = encryptedPassword
                PasswordDomain --> PasswordService: void
                deactivate PasswordDomain

                ' Atualizar modelo
                PasswordService -> PasswordService: currentPasswordModel.updateFromEntity(passwordEntity)

                ' Salvar no banco
                PasswordService -> PasswordDAO: save(currentPasswordModel)
                activate PasswordDAO
                PasswordDAO -> Database: UPDATE passwords SET value = ? WHERE id = ?
                activate Database
                Database --> PasswordDAO: PasswordModel
                deactivate Database
                PasswordDAO --> PasswordService: PasswordModel
                deactivate PasswordDAO

                PasswordService --> Controller: void
                deactivate PasswordService

                Controller -> Router: res.status(200).json(success)
                Router -> Client: 200 - Senha atualizada com sucesso
            end
        end
    end
end
deactivate Controller
deactivate Router

== Fluxo de Validações (Detalhado) ==

note over PasswordDomain : **Validações da Nova Senha:**\n• Pelo menos 1 letra minúscula\n• Pelo menos 1 letra maiúscula\n• Pelo menos 1 caractere especial\n• Entre 8 e 20 caracteres

note over PasswordDomain : **Processo de Criptografia:**\n• Geração de salt (bcrypt)\n• Hash da senha com salt\n• Armazenamento do hash

note over PasswordDomain : **Validação da Senha Atual:**\n• Comparação do plain text\n• Com hash armazenado\n• Usando bcrypt.compareSync()

@enduml
